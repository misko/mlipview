<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>FAIRChem UMA viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
  html,body { margin:0; padding:0; height:100%; background:#ffffff; font-family: system-ui, sans-serif; color:#222; }
    #app { position:relative; width:100%; height:100%; overflow:hidden; }
    canvas { width:100%; height:100%; display:block; }
    .hud { position:absolute; top:8px; left:8px; background:rgba(20,26,34,0.65); border:1px solid rgba(255,255,255,0.07); border-radius:8px; padding:8px 12px; font-size:13px; backdrop-filter: blur(4px); }
    .hud button { margin-right:6px; }
    .footer { position:absolute; bottom:8px; left:8px; font-size:11px; opacity:0.6; }
    a { color:#7fc4ff; }
    /* Removed standalone VR/AR buttons; unified AR transparency toggle lives in HUD */
    .hud .inline-toggle { display:inline-flex; align-items:center; gap:4px; margin-left:4px; }
  </style>
  <script>
    // Predeclare global so console commands entered early don't throw ReferenceError
    (function(){ try { if(typeof window!=='undefined' && !('viewerApi' in window)) window.viewerApi = null; } catch{} })();
  </script>
  <script>
    // Optional latency debug: enable with ?debugLatency=1 to log round-trip times of all fetch() calls
    // and JSON/text parse times. This helps separate pure network IO from client-side overhead.
    (function(){
      try {
        const params = new URLSearchParams(location.search||'');
        if (params.get('debugLatency') === '1') {
          try { window.__MLIP_DEBUG_LATENCY = true; } catch {}
          const origFetch = (typeof window!=='undefined' && window.fetch) ? window.fetch.bind(window) : null;
          if (origFetch && !window.__MLIP_FETCH_LATENCY_WRAPPED__) {
            window.__MLIP_FETCH_LATENCY_WRAPPED__ = true;
            window.fetch = async function(input, init){
              const method = (init && init.method) || (input && input.method) || 'GET';
              const url = (typeof input === 'string') ? input : (input && (input.url || input.toString())) || 'unknown';
              const t0 = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now();
              try {
                const resp = await origFetch(input, init);
                const t1 = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now();
                const ms = Math.round((t1 - t0)*100)/100;
                const status = (resp && typeof resp.status==='number') ? resp.status : 'n/a';
                console.log(`[latency] ${method} ${url} -> ${status} in ${ms} ms`);

                // Wrap resp.json/text to measure client-side parse time
                try {
                  const proto = Object.getPrototypeOf(resp);
                  if (proto && !resp.__MLIP_PARSE_WRAPPED__) {
                    Object.defineProperty(resp, '__MLIP_PARSE_WRAPPED__', { value: true, configurable: true });
                    if (typeof resp.json === 'function') {
                      const origJson = resp.json.bind(resp);
                      resp.json = async function(){
                        const p0 = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now();
                        try { return await origJson(); }
                        finally {
                          const p1 = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now();
                          const pms = Math.round((p1 - p0)*100)/100;
                          console.log(`[latency] parse json ${method} ${url} in ${pms} ms`);
                        }
                      };
                    }
                    if (typeof resp.text === 'function') {
                      const origText = resp.text.bind(resp);
                      resp.text = async function(){
                        const p0 = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now();
                        try { return await origText(); }
                        finally {
                          const p1 = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now();
                          const pms = Math.round((p1 - p0)*100)/100;
                          console.log(`[latency] parse text ${method} ${url} in ${pms} ms`);
                        }
                      };
                    }
                  }
                } catch {}
                return resp;
              } catch (err) {
                const t1 = (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now();
                const ms = Math.round((t1 - t0)*100)/100;
                const msg = (err && (err.message||String(err))) || 'error';
                console.warn(`[latency] ${method} ${url} -> network error in ${ms} ms: ${msg}`);
                throw err;
              }
            };
            try { console.log('[latency] fetch timing enabled'); } catch{}
          }
        }
      } catch {}
    })();
  </script>
</head>
<body>
  <div id="app">
    <canvas id="viewer"></canvas>
    <!-- Minimal status placeholder to satisfy smoke tests before panel builds -->
    <span id="status" style="position:absolute;left:-9999px;top:-9999px;">Ready</span>
    <div class="footer">FAIRChem UMA viewer</div>
  </div>
  <script type="module">
    await import('@src/babylonLegacy.ts');
    const urlParams = new URLSearchParams(location.search || '');
    const useReactShell = urlParams.get('ui') === 'react';

    try {
      if (useReactShell) {
        await import('@src/main.tsx');
      } else {
        const { bootstrapLegacyViewer } = await import('./bootstrapLegacyViewer.js');
        await bootstrapLegacyViewer({
          canvas: document.getElementById('viewer'),
          appRoot: document.getElementById('app'),
          statusElement: document.getElementById('status'),
          urlParams,
        });
      }
    } catch (err) {
      console.error('[bootstrap] failed', err);
      const statusEl = document.getElementById('status');
      if (statusEl) statusEl.textContent = 'Bootstrap failed';
      if (typeof window !== 'undefined') {
        try { window.__MLIP_BOOTSTRAP_ERROR__ = err; } catch {}
      }
    }
  </script>
</body>
</html>
