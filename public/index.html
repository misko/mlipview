<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>MLIP Viewer 2</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    html,body { margin:0; padding:0; height:100%; background:#0b0f14; font-family: system-ui, sans-serif; color:#d8e6f3; }
    #app { position:relative; width:100%; height:100%; overflow:hidden; }
    canvas { width:100%; height:100%; display:block; }
    .hud { position:absolute; top:8px; left:8px; background:rgba(20,26,34,0.65); border:1px solid rgba(255,255,255,0.07); border-radius:8px; padding:8px 12px; font-size:13px; backdrop-filter: blur(4px); }
    .hud button { margin-right:6px; }
    .footer { position:absolute; bottom:8px; left:8px; font-size:11px; opacity:0.6; }
    a { color:#7fc4ff; }
    /* Removed standalone VR/AR buttons; unified AR transparency toggle lives in HUD */
    .hud .inline-toggle { display:inline-flex; align-items:center; gap:4px; margin-left:4px; }
  </style>
  <!-- Load Babylon globally so legacy-style modules that reference global BABYLON work -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <!-- Loaders plugin for glTF/glb (controllers, hand meshes) -->
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
</head>
<body>
  <div id="app">
    <canvas id="viewer"></canvas>
  <div class="hud">
  <button id="btnRelax">Relax Step</button>
  <button id="btnRelaxRun">Relax Run</button>
  <button id="btnMD">MD Step</button>
  <button id="btnMDRun">MD Run</button>
  <button id="btnStopSim">Stop</button>
      <select id="forceProviderSel"><option value="local">Local LJ</option><option value="fairchem">FairChem</option></select>
      <button id="btnRebonds">Recompute Bonds</button>
  <button id="btnCell">Cell</button>
  <button id="btnGhosts">Ghosts</button>
      <span id="status">Ready</span>
      <select id="xrModeSelect" style="margin-left:6px" title="Switch XR mode">
        <option value="none">XR:none</option>
        <option value="vr">VR</option>
        <option value="ar">AR</option>
      </select>
      <div id="energyPlot" style="margin-top:6px;width:260px;height:80px;background:rgba(255,255,255,0.05);position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.08);border-radius:4px;">
        <canvas id="energyCanvas" width="260" height="80" style="position:absolute;left:0;top:0;"></canvas>
        <div id="energyLabel" style="position:absolute;left:4px;top:2px;font-size:10px;opacity:0.8;">E plot</div>
      </div>
      <div id="bond-rotation-ui" style="position:absolute;top:10px;right:10px;display:none;z-index:10;font-family:Arial;">
        <button id="bond-rot-minus" style="margin:2px;">-</button>
        <button id="bond-rot-plus" style="margin:2px;">+</button>
      </div>
    </div>
    <div class="footer">MLIP Viewer 2 â€“ separate project</div>
  </div>
  <script type="module">
    import { initNewViewer } from './index.js';
    import { loadDefault, loadXYZIntoViewer } from './util/moleculeLoader.js';
    const urlParams = new URLSearchParams(location.search);
    const DEBUG = urlParams.get('debug') === '1';
    const canvas=document.getElementById('viewer');
    let viewerApi;
    // Desktop initialization (runs immediately; we keep always-on desktop mode and allow VR overlay switch)
    (async()=>{
      // Start with empty molecule; loader will populate.
      viewerApi = await initNewViewer(canvas,{ elements:[], positions:[], bonds:[] });
      // Always expose viewer globally for VR reuse (was previously behind DEBUG flag)
      window._viewer = viewerApi;
      window.vrScene = viewerApi.scene; // redundancy for VR module
      window.vrEngine = viewerApi.engine;
      if (DEBUG) console.log('[debug] viewer initialized');
      // Bond rotation UI wiring
      const rotUI = document.getElementById('bond-rotation-ui');
      const rotMinus = document.getElementById('bond-rot-minus');
      const rotPlus = document.getElementById('bond-rot-plus');
      const EPS = 0.1; // radians per click
      function refreshRotationUI() {
        const sel = viewerApi.selection.get();
        if (sel.kind === 'bond') rotUI.style.display = 'block'; else rotUI.style.display = 'none';
      }
      viewerApi.state.bus.on('selectionChanged', refreshRotationUI);
      rotMinus.addEventListener('click', ()=>{ viewerApi.manipulation.rotateBond(-EPS); });
      rotPlus.addEventListener('click', ()=>{ viewerApi.manipulation.rotateBond(EPS); });
      try {
        const { file } = await loadDefault(viewerApi);
        document.getElementById('status').textContent = `Loaded ${file}`;
        if (DEBUG) console.log('[debug] default molecule loaded', file, 'atoms=', viewerApi.state.positions.length);
        window.__MLIP_DEFAULT_LOADED = true;
      } catch (e) {
        document.getElementById('status').textContent = 'Load failed';
        console.error(e);
        window.__MLIP_DEFAULT_LOADED = true; // still allow tests to proceed
      }
    })();
  document.getElementById('btnRelax').onclick=()=>{ if (!viewerApi) return; viewerApi.relaxStep(); document.getElementById('status').textContent='Relax step'; };
  document.getElementById('btnRelaxRun').onclick=async()=>{ if(!viewerApi) return; document.getElementById('status').textContent='Relax running'; viewerApi.startRelaxContinuous({}).then(r=>{ document.getElementById('status').textContent = r?.converged? 'Relax converged':'Relax stopped'; }); };
    document.getElementById('btnMD').onclick=()=>{ if (!viewerApi) return; viewerApi.mdStep(); document.getElementById('status').textContent=`MD T=${viewerApi.state.dynamics.temperature.toFixed(2)}`; };
  document.getElementById('btnMDRun').onclick=()=>{ if(!viewerApi) return; document.getElementById('status').textContent='MD running'; viewerApi.startMDContinuous({}); };
  document.getElementById('btnStopSim').onclick=()=>{ if(!viewerApi) return; viewerApi.stopSimulation(); document.getElementById('status').textContent='Stopped'; };
  document.getElementById('forceProviderSel').onchange = (e)=>{ if(!viewerApi) return; const kind=e.target.value; viewerApi.setForceProvider(kind); document.getElementById('status').textContent='Provider '+kind; };

  // Periodic metrics HUD updater
  setInterval(()=>{ if(!viewerApi) return; const m=viewerApi.getMetrics(); if(!m.running) return; const parts=[]; if(m.energy!=null) parts.push('E='+m.energy.toFixed(3)); if(m.maxForce!=null) parts.push('Fmax='+m.maxForce.toExponential(2)); if(m.maxStress!=null) parts.push('Smax='+m.maxStress.toExponential(2)); document.getElementById('status').textContent = (m.running||'idle')+' '+parts.join(' '); }, 500);
    document.getElementById('btnRebonds').onclick=()=>{ if (!viewerApi) return; viewerApi.recomputeBonds(); document.getElementById('status').textContent='Recomputed bonds'; };
  document.getElementById('btnCell').onclick=()=>{ if(!viewerApi) return; (viewerApi.state.toggleCellVisibilityEnhanced||viewerApi.state.toggleCellVisibility).call(viewerApi.state); document.getElementById('status').textContent = viewerApi.state.showCell? 'Cell ON':'Cell OFF'; };
  document.getElementById('btnGhosts').onclick=()=>{ if(!viewerApi) return; viewerApi.state.toggleGhostCells(); document.getElementById('status').textContent = viewerApi.state.showGhostCells? 'Ghosts ON':'Ghosts OFF'; };
    // Simple molecule switch UI (development convenience)
    const switcher = document.createElement('select');
    switcher.innerHTML = '<option value="molecules/roy.xyz">ROY</option><option value="molecules/benzene.xyz">Benzene</option>';
    switcher.onchange = async () => {
      if (!viewerApi) return;
      const file = switcher.value;
      document.getElementById('status').textContent = `Loading ${file}...`;
      try {
        await loadXYZIntoViewer(viewerApi, file);
        document.getElementById('status').textContent = `Loaded ${file}`;
        if (DEBUG) console.log('[debug] switched molecule', file, 'atoms=', viewerApi.state.positions.length);
      } catch (e) {
        document.getElementById('status').textContent = `Failed ${file}`;
      }
    };
    document.querySelector('.hud').appendChild(switcher);

    // XR dropdown wiring (now static in markup for reliability)
    const xrSel = document.getElementById('xrModeSelect');
    xrSel.addEventListener('change', async ()=> {
      if(!viewerApi) return;
      const v = xrSel.value;
      if(v==='none'){ await viewerApi.vr.switchXR('none'); }
      else if(v==='vr'){ await viewerApi.vr.switchXR('vr'); }
      else if(v==='ar'){ await viewerApi.vr.switchXR('ar'); }
    });
    setInterval(()=>{
      if(!viewerApi) return;
      try {
        const info=viewerApi.vr.debugInfo();
        let mode='none';
        if(info.sessionMode.includes('ar')) mode='ar';
        else if(info.sessionMode.includes('vr')||info.hasXRHelper && info.sessionMode!=='unknown') mode='vr';
        if(xrSel.value!==mode) xrSel.value=mode;
      } catch{}
    }, 2000);
  </script>
</body>
</html>
